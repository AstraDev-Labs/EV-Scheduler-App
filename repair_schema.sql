-- =========================================================
-- DATABASE REPAIR & UPDATE SCRIPT
-- Run this entire script in the Supabase SQL Editor
-- =========================================================

-- 1. Create table if it was somehow deleted or missing
CREATE TABLE IF NOT EXISTS public.chargers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  location JSONB,
  status TEXT CHECK (status IN ('Available', 'Occupied', 'Offline')) DEFAULT 'Available',
  cost_per_kwh FLOAT DEFAULT 12.0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. Add the 'power_kw' column if it's missing (Safe to run multiple times)
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'chargers' AND column_name = 'power_kw') THEN
        ALTER TABLE public.chargers ADD COLUMN power_kw FLOAT DEFAULT 7.0;
    END IF;
END $$;

-- 3. Insert sample data ONLY if the table is empty
INSERT INTO public.chargers (name, location, status, cost_per_kwh, power_kw)
SELECT 'New EV1', '{"lat": 12.9716, "lng": 77.5946}', 'Available', 100.0, 3.3
WHERE NOT EXISTS (SELECT 1 FROM public.chargers);

-- 4. Update the specific charger "New EV1" to have the correct power rating
-- This fixes the "Too High Cost" issue for existing rows
UPDATE public.chargers 
SET power_kw = 3.3 
WHERE name = 'New EV1';

-- 5. Verification: Show the result
SELECT id, name, cost_per_kwh, power_kw FROM public.chargers;
